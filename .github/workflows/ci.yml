name: .NET 9 CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET 9 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    # Optional: respect global.json automatically (no extra step needed)

    - name: Restore
      run: dotnet restore DGC.StaffManagement.sln

    - name: Build (Release)
      run: dotnet build DGC.StaffManagement.sln -c Release --no-restore

    - name: Test (if any *Tests.csproj)
      shell: bash
      run: |
        if ls **/*Tests.csproj 1> /dev/null 2>&1; then
          for proj in $(ls **/*Tests.csproj); do
            echo "Running tests in $proj"
            dotnet test "$proj" -c Release --no-build --collect:"XPlat Code Coverage" --logger "trx;LogFileName=test_results.trx"
          done
        else
          echo "No test projects found. Skipping tests."
        fi

    - name: Publish WebApi artifact (optional)
      run: dotnet publish DGC.StaffManagement.WebApi/DGC.StaffManagement.WebApi.csproj -c Release -o ./publish

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapi-publish
        path: publish
